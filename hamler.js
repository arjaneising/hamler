(function(){var Hamler,__slice=[].slice,__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};Hamler=function(){function Hamler(e,t){this.options=t!=null?t:{};this.templates={};this.queue=[];if(e.indexOf("\n")===-1)this.loadResource(e);else{this.completed=!0;this.templates[0]=e;this.render(0,t)}return this}Hamler.prototype.loadResource=function(e){var t,n,r,i,s;t=window.jQuery||this.options.jQuery||!1;n=this;n.completed=!1;if(typeof require=="function")return require(["text!"+e],function(e){n.completed=!0;n.parseFile.call(n,e);return n.clearQueue()});if(t){r=t.ajax(e,{cache:(s=this.options.cache)!=null?s:!0,dataType:"text"});r.done(function(e){n.completed=!0;n.parseFile.call(n,e);return n.clearQueue()});return r}try{i=new XMLHttpRequest}catch(o){try{i=new ActiveXObject("Msxml2.XMLHTTP")}catch(o){try{i=new ActiveXObject("Microsoft.XMLHTTP")}catch(o){i=!1}}}if(!i)return null;try{i.open("get",e);i.onreadystatechange=function(e){if(i.readyState===4&&!n.completed){n.completed=!0;n.parseFile.call(n,i.responseText);return n.clearQueue()}};i.send(null)}catch(o){return!1}return i};Hamler.prototype.parseFile=function(e){var t,n,r,i,s,o,u,a,f;s=/^\${3}\s([a-zA-Z0-9]+)\s\${3}$/;r=e.split("\n");i=null;f=[];for(o=0,u=r.length;o<u;o++){n=r[o];if(s.test(n)){a=n.match(s),t=a[0],i=a[1];f.push(this.templates[i]=[])}else i?f.push(this.templates[i].push(n)):f.push(void 0)}return f};Hamler.prototype.clearQueue=function(){var e,t;t=[];while(this.queue.length){e=this.queue.shift();t.push(this.render(e.name,e.options))}return t};Hamler.prototype.render=function(e,t){var n,r,i;if(!this.completed){this.queue.push({name:e,options:t});return!1}r=(i=t.vars)!=null?i:{};n=this.haml(this.templates[e],r);return t.append?t.append.appendChild(n):t.prepend?t.prepend.insertBefore(n,t.prepend.firstChild):t.before?t.before.parentNode.insertBefore(n,t.before):t.after?t.after.parentNode.insertBefore(n,t.after.nextSibling):n};Hamler.prototype.haml=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;m=!1;typeof e=="string"&&(e=e.split("\n"));l=0;p=-1;r=[document.createDocumentFragment()];a=[];for(u in e){c=e[u];f=c.match(/^[\s]+/);m===!1&&f!==null&&(m=f[0].length);l=0;f!==null&&(l=f[0].length/m);d=!0;for(b=0,x=a.length;b<x;b++){s=a[b];if(s.active===!1)continue;if(s.type==="each")if(l>s.level){s.collected.push(c.substr((s.level+1)*m));d=!1}else{s.active=!1;L=t[s.loop];for(w=0,T=L.length;w<T;w++){y=L[w];n=this.cloneObj(t);n[s.key]=y;r[s.level].appendChild(this.haml(s.collected,n))}r[s.level]=r[s.level-1].lastChild}else if(l>s.level){s.show&&s.collected.push(c.substr((s.level+1)*m));d=!1}else{s.active=!1;if(s.collected.length){n=this.cloneObj(t);r[s.level].appendChild(this.haml(s.collected,n));r[s.level+1]=r[s.level].lastChild}}}if(!d)continue;o=this.parseLine(c,t);if(typeof o=="string"){A=o.split("|"),g=A[0],i=2<=A.length?__slice.call(A,1):[];if(g==="if"||g==="elseif"||g==="else"){v=i[0];if(v==="o"){h=null;for(u=E=O=a.length-1;O<=0?E<=0:E>=0;u=O<=0?++E:--E){s=a[u];if(s.level===l&&s.type==="if"){h=s.show;break}}if(h===null)throw"Nothing to else or elseif from";v=h?"h":"s"}a.push({active:!0,level:l,show:v==="s",type:g,collected:[]})}else a.push({active:!0,level:l,type:"each",collected:[],loop:i[0],key:i[1]});continue}if(!o)continue;if(l<p){r.splice(l+1,p-l);r[r.length-2].appendChild(o);r[r.length-1]=o}else if(l===p){r[r.length-2].appendChild(o);r[r.length-1]=o}else{if(l-p!==1)throw"Too much indentation";r[l].appendChild(o);r[l+1]=o}p=l}for(S=0,N=a.length;S<N;S++){s=a[S];if(s.active===!1)continue;if(s.type==="each"){M=t[s.loop];for(k=0,C=M.length;k<C;k++){y=M[k];n=this.cloneObj(t);n[s.key]=y;r[s.level].appendChild(this.haml(s.collected,n));r.splice(s.level+1,Infinity)}}else if(s.collected.length){n=this.cloneObj(t);r[s.level].appendChild(this.haml(s.collected,n));r.splice(s.level+1,Infinity)}}return r[0]};Hamler.prototype.cloneObj=function(e){var t,n,r;t={};for(n in e){r=e[n];typeof r=="object"?t[n]=this.cloneObj(r):t[n]=r}return t};Hamler.prototype.parseLine=function(e,t){var n,r,i,s,o,u,a,f,l,c,h;n=this.cloneObj(t);e=e.replace(/^\s+/,"");if(e.length===0)return!1;f=e.match(/^(%[a-zA-Z0-9]+)?(\.[.-\w\u00C0-\uFFFF]+)?(\#[-\w\u00C0-\uFFFF=$]+)?(\.[.-\w\u00C0-\uFFFF]+)?((\{[^}]+\})|(\([^)]+\)))?(=?[\s]+[\s\S]+)?$/);if(f===null){if(e.indexOf("-")===0){r=e.match(/^\-\s+(if|unless|elseif|else|@([a-zA-Z0-9.]+)\.each\sdo\s\|([a-zA-Z0-9]+)\|)/);if(r===null)throw"Unrecognized control structure";if(!r[2]){if(r[1]==="if"||r[1]==="unless"){l=this.evaluate(e.substring(r[0].length),n);r[1]==="unless"&&(l=!l);return l?"if|s":"if|h"}if(r[1]==="elseif"){l=this.evaluate(e.substring(r[0].length),n);return l?"elseif|o":"elseif|h"}return"elseif|o"}return"each|"+r[2]+"|"+r[3]}return this.htmlify(e)}if(!(f[1]||f[2]||f[3]||f[4]||f[5])&&e.indexOf("=")===0)return this.htmlify(this.evaluate(f[8].substr(1),n));a="div";f[1]&&(a=f[1].substr(1));s={};o=(f[2]||"")+(f[4]||"");o=o.replace(/\./g," ").replace(/^\s+|\s+$/g,"");o.length&&(s["class"]=o);f[3]&&(s.id=f[3].substr(1));f[5]&&this.parseAttrs(s,f[5],n);u=document.createElement(a);for(i in s){h=s[i];u.setAttribute(i,h)}if(f[8]){c=f[8];c.indexOf("=")===0&&(c=this.evaluate(f[8].substr(1),n));u.appendChild(this.htmlify(c))}return u};Hamler.prototype.htmlify=function(e){var t,n;n=document.createDocumentFragment();t=document.createElement("div");t.innerHTML=e;n.appendChild(t);while(t.firstChild)n.appendChild(t.removeChild(t.firstChild));n.removeChild(t);return n};Hamler.prototype.evaluate=function(str,$v){str=str.replace(/@([a-zA-Z0-9])/g,"$v.$1");return eval(str)};Hamler.prototype.parseAttrs=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;h=t.substr(1,t.length-2).split("");r="";i="";l=[];u=!0;for(o=d=0,m=h.length;d<m;o=++d){c=h[o];a=o<h.length-1?h[o+1]:"";if(!u||c!==" ")i+=c;if(__indexOf.call(r.split(""),c)>=0){l.push(i);r="";i="";u=!0}else if(c===","&&!r){l.push(i);r="";i="";u=!0}else if(c==='"'&&!r){r='"';u=!1}else if(c==="`"&&!r){r="`";u=!1}else if(c==="'"&&!r){r="'";u=!1}else c===":"&&!r?r=">":c==="="&&!r?r=" ":c==="@"&&!r&&(r=", ")}s=null;p=null;for(v=0,g=l.length;v<g;v++){f=l[v];if(f.indexOf('"')===0||f.indexOf("'")===0)p=f.substr(1,f.length-2);else if(f.indexOf("@")===0){f.lastIndexOf(",")===f.length-1&&(f=f.substr(0,f.length-1));p=this.evaluate(f,n)}else if(f.indexOf("`")===0)p=this.evaluate(f.substr(1,f.length-2),n);else{f.indexOf(":")===0?s=f.substr(1,f.length-3):s=f.substr(0,f.length-1);p=null}if(s&&p){e[s]=p;s=null;p=null}}};return Hamler}();window.Hamler=Hamler;typeof define=="function"&&define.amd&&define("Hamler",function(){return Hamler})}).call(this);